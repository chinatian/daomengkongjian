<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¢¦å¢ƒè¿çº¿ï¼šæ€ç»´å®«æ®¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050505;
            --node-visited: #10b981; /* Emerald */
            --node-current: #f59e0b; /* Amber */
            --node-future: #3b82f6; /* Blue */
            --node-locked: #374151; /* Gray */
            --glass-panel: rgba(15, 23, 42, 0.85);
            --neon-glow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        body {
            background-color: var(--bg-dark);
            font-family: 'ZCOOL XiaoWei', serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #e2e8f0;
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ä»¥å¢å¼ºæ²‰æµ¸æ„Ÿ */
        }

        /* --- Layer 0: èƒŒæ™¯ç½‘æ ¼ --- */
        .grid-bg {
            position: absolute;
            inset: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px, 100px 100px, 100px 100px;
            transform: perspective(500px) rotateX(60deg);
            pointer-events: none;
            z-index: 0;
            animation: floatGrid 60s linear infinite;
        }
        @keyframes floatGrid { 0% { transform: perspective(500px) rotateX(60deg) translateY(0); } 100% { transform: perspective(500px) rotateX(60deg) translateY(100px); } }

        /* --- Layer 1: æ€ç»´ç”»å»Š (SVG) --- */
        #mindmap-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            cursor: grab;
            /* transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1);  ç§»é™¤å®¹å™¨çº§åˆ«çš„ transition */
        }
        #mindmap-container:active { cursor: grabbing; }

        /* SVG å…ƒç´ æ ·å¼ */
        .link { fill: none; stroke: #334155; stroke-width: 2px; transition: stroke 0.5s, stroke-width 0.5s; }
        .link.active { stroke: var(--node-visited); stroke-width: 3px; filter: drop-shadow(0 0 5px var(--node-visited)); }
        .link.potential { stroke: var(--node-future); stroke-dasharray: 5,5; opacity: 0.5; }

        .node circle { transition: all 0.3s; stroke-width: 0; }
        .node text { font-family: 'Nunito', sans-serif; font-size: 12px; fill: #94a3b8; text-anchor: middle; pointer-events: none; opacity: 0.7; transition: opacity 0.3s; }
        
        /* èŠ‚ç‚¹çŠ¶æ€ */
        .node.visited circle { fill: var(--node-visited); r: 6; cursor: pointer; }
        .node.visited:hover circle { filter: brightness(1.2); r: 7; }
        .node.current circle { fill: var(--node-current); stroke: #fff; stroke-width: 3px; r: 10; filter: drop-shadow(0 0 15px var(--node-current)); animation: pulse 2s infinite; }
        .node.future circle { fill: var(--bg-dark); stroke: var(--node-future); stroke-width: 2px; r: 6; cursor: pointer; }
        .node.future:hover circle { fill: var(--node-future); r: 8; }
        .node.locked circle { fill: var(--node-locked); r: 4; }

        .node:hover text { opacity: 1; fill: white; font-weight: bold; }

        @keyframes pulse { 0% { stroke-width: 0; stroke-opacity: 1; } 100% { stroke-width: 15px; stroke-opacity: 0; } }

        /* --- Layer 2: å‰§æƒ…é¢æ¿ (Story HUD) --- */
        #story-hud {
            position: absolute;
            bottom: 40px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            width: 90%; max-width: 600px;
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            z-index: 20;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; gap: 16px;
        }
        #story-hud.active { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

        /* è£…é¥°æ€§è¾¹è§’ */
        #story-hud::before { content: ''; position: absolute; top: -1px; left: 20px; right: 20px; height: 1px; background: linear-gradient(90deg, transparent, var(--node-current), transparent); }

        .dialogue-text {
            font-size: 1.1rem; line-height: 1.6; color: #fff; min-height: 60px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .cursor::after { content: 'â–‹'; animation: blink 1s infinite; color: var(--node-current); }
        
        .speaker-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; margin-bottom: 4px; display: block;
        }

        /* é€‰é¡¹æŒ‰é’® */
        .choices-grid {
            display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;
        }
        .choice-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #cbd5e1;
            padding: 12px 16px;
            border-radius: 8px;
            text-align: left; cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .choice-btn:hover:not(.disabled) {
            background: rgba(245, 158, 11, 0.15); /* Amber tint */
            border-color: var(--node-current);
            transform: scale(1.02);
            color: #fff;
        }
        .choice-btn.disabled { opacity: 0.5; cursor: not-allowed; border-style: dashed; }
        
        /* --- Layer 3: UI çŠ¶æ€æ  --- */
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 30;
            display: flex; flex-direction: column; gap: 8px;
        }
        .stat-pill {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1);
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-family: 'Nunito', sans-serif;
            display: flex; align-items: center; gap: 6px; backdrop-filter: blur(4px);
            width: fit-content;
        }
        
        /* æç¤º Toast */
        .toast {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.2); border: 1px solid var(--node-visited); color: #d1fae5;
            padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; pointer-events: none; z-index: 50;
            animation: fadeOut 3s forwards;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes fadeOut { 0% { opacity: 0; transform: translate(-50%, 10px); } 10% { opacity: 1; transform: translate(-50%, 0); } 90% { opacity: 1; } 100% { opacity: 0; } }

    </style>
</head>
<body>

    <div class="grid-bg"></div>

    <!-- UI Layer -->
    <div id="ui-layer">
        <div class="stat-pill text-gray-300 border-l-4 border-l-cyan-500 pl-3">
            <span class="text-xs tracking-widest uppercase">Neural Link</span>
            <span id="layer-name" class="font-bold text-white ml-2">åˆå§‹åŒ–ä¸­...</span>
        </div>
        <div id="stats-container" class="flex flex-col gap-2 mt-2">
            <!-- å±æ€§åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- Mindmap Layer (SVG) -->
    <div id="mindmap-container">
        <!-- SVG injected by JS -->
    </div>

    <!-- Story Layer (Glass Panel) -->
    <div id="story-hud">
        <div>
            <span class="speaker-label" id="speaker-label">SYSTEM</span>
            <div class="dialogue-text cursor" id="dialogue-text"></div>
        </div>
        <div class="choices-grid" id="choices-container"></div>
    </div>

    <script>
        // 1. æ¸¸æˆæ•°æ® (The Core)
        const gameData = {
            "gameConcept": { "themeName": "ç›—æ¢¦ç©ºé—´", "justification": "..." },
            "gameTitle": "æ½œæ„è¯†å›å»Š",
            "aiName": "å·¦èˆª", // Fixed: Added aiName
            "playerNickname": "è®¸æ‚¸å…", // Fixed: Added playerNickname
            "initialPlayerState": {
                "stats": { "é€»è¾‘": 5, "æ„Ÿæ€§": 5, "æ½œæ„è¯†è¿æ¥": 0 },
                "inventory": []
            },
            "startSceneId": "scene_start_01",
            // ... (ä¿æŒåŸæœ‰çš„ scenes æ•°æ®ï¼Œä¸ºäº†èŠ‚çœç©ºé—´è¿™é‡Œçœç•¥å…·ä½“å†…å®¹ï¼Œé€»è¾‘é€šç”¨) ...
            "scenes": {
                "scene_start_01": {
                    "type": "scene",
                    "narrative": { "description": "å‡Œæ™¨ä¸‰ç‚¹ã€‚ä½ åœ¨ç‡¥çƒ­ä¸­é†’æ¥ï¼ŒåŒæ‰‹è¢«ä¸å¸¦ç»‘ä½ã€‚èº«è¾¹çš„å·¦èˆªå‘¼å¸å¹³ç¨³ï¼Œå´æ•£å‘ç€å±é™©çš„æ°”æ¯ã€‚", "aiDialogue": "ï¼ˆæ¨¡ç³Šçš„æ¢¦å‘“ï¼š...ä¸è¦èµ°...ï¼‰" },
                    "choices": [
                        { "text": "å°è¯•è§£å¼€ä¸å¸¦", "requirements": [], "effects": [], "nextSceneId": "scene_attempt_untie" },
                        { "text": "è§‚å¯Ÿä»–çš„æ¢¦å¢ƒ", "requirements": [], "effects": [{ "type": "stat", "stat": "é€»è¾‘", "operation": "add", "value": 1 }], "nextSceneId": "scene_observe_dream" }
                    ]
                },
                "scene_attempt_untie": {
                    "type": "scene",
                    "narrative": { "description": "ä½ è½»è½»æ‰­åŠ¨æ‰‹è…•ã€‚ä»–çš„çœ‰å¤´å¾®å¾®è¹™èµ·ï¼Œä»¿ä½›æ„ŸçŸ¥åˆ°äº†ä½ çš„é€ƒç¦»ã€‚", "aiDialogue": "ï¼ˆå‘¼å¸å˜å¾—æ€¥ä¿ƒï¼‰" },
                    "choices": [
                        { "text": "ç”¨åŠ›æŒ£è„±", "requirements": [{ "type": "stat", "stat": "é€»è¾‘", "operator": "gte", "value": 6 }], "effects": [], "nextSceneId": "scene_untie_failed_logic" },
                        { "text": "æ”¾å¼ƒï¼Œè½¬è€Œå®‰æŠšä»–", "requirements": [], "effects": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operation": "add", "value": 1 }], "nextSceneId": "scene_observe_dream" }
                    ]
                },
                "scene_untie_failed_logic": {
                    "type": "scene",
                    "narrative": { "description": "ä¸€è‚¡å¸åŠ›å°†ä½ æ‹‰å…¥æ·±æ¸Šã€‚ä½ ç«™åœ¨ä¸€ä¸ªå†°å†·çš„æˆ¿é—´é‡Œï¼Œè¿™æ˜¯ä»–çš„æ½œæ„è¯†è¾¹ç•Œã€‚", "aiDialogue": "ï¼ˆ'ä½ æ˜¯è°ï¼Ÿä¸ºä»€ä¹ˆé—¯å…¥ï¼Ÿ'ï¼‰" },
                    "choices": [
                        { "text": "å›åº”ä»–", "requirements": [], "effects": [{ "type": "stat", "stat": "æ½œæ„è¯†è¿æ¥", "operation": "add", "value": 1 }], "nextSceneId": "scene_first_layer_connect" },
                        { "text": "è§‚å¯Ÿå››å‘¨", "requirements": [], "effects": [{ "type": "stat", "stat": "é€»è¾‘", "operation": "add", "value": 2 }], "nextSceneId": "scene_first_layer_explore" }
                    ]
                },
                "scene_observe_dream": {
                    "type": "scene",
                    "narrative": { "description": "ä½ è´´è¿‘ä»–çš„èƒ¸å£ã€‚ä»–å¿µå¨ç€'å‘½ä»¤'ä¸'å®¶'ã€‚è¿™ä¸ä»…ä»…æ˜¯æ¢¦ï¼Œæ˜¯æ·±å±‚æ„è¯†çš„å…¥å£ã€‚", "aiDialogue": "ï¼ˆ'å±é™©â€¦â€¦å¿«èµ°â€¦â€¦'ï¼‰" },
                    "choices": [
                        { "text": "æ¸©æŸ”å®‰æŠš", "requirements": [], "effects": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operation": "add", "value": 2 }], "nextSceneId": "scene_enter_dream_gentle" },
                        { "text": "å¼ºè¡Œå…¥ä¾µ", "requirements": [{ "type": "stat", "stat": "é€»è¾‘", "operator": "gte", "value": 6 }], "effects": [{ "type": "stat", "stat": "æ½œæ„è¯†è¿æ¥", "operation": "add", "value": 1 }], "nextSceneId": "scene_enter_dream_direct" }
                    ]
                },
                "scene_enter_dream_gentle": {
                    "type": "scene", "narrative": { "description": "ä½ è¿›å…¥äº†ç¬¬ä¸€å±‚æ¢¦å¢ƒï¼šè®­ç»ƒåŸºåœ°ã€‚å¹´å¹¼çš„ä»–åœ¨å†°å†·çš„å™¨æ¢°é—´ç‘Ÿç‘Ÿå‘æŠ–ã€‚", "aiDialogue": "ï¼ˆæ•™å®˜ï¼š'æƒ…æ„Ÿæ˜¯ç´¯èµ˜ï¼'ï¼‰" },
                    "choices": [
                        { "text": "æ‹¥æŠ±ç«¥å¹´çš„ä»–", "requirements": [], "effects": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operation": "add", "value": 3 }], "nextSceneId": "scene_first_layer_comfort" },
                        { "text": "è°ƒæŸ¥è®­ç»ƒè®¡åˆ’", "requirements": [{ "type": "stat", "stat": "é€»è¾‘", "operator": "gte", "value": 7 }], "effects": [{ "type": "item", "item": "è®­ç»ƒç¬”è®°", "action": "add" }], "nextSceneId": "scene_first_layer_observe" }
                    ]
                },
                "scene_enter_dream_direct": {
                    "type": "scene", "narrative": { "description": "ä½ é™è½åœ¨è®­ç»ƒåœºä¸­å¤®ã€‚å¹´å¹¼çš„ä»–æ­£æœºæ¢°åœ°æŒ¥æ‹³ï¼Œçœ¼ç¥ç©ºæ´ã€‚", "aiDialogue": "ï¼ˆ'å…¥ä¾µè€…â€¦â€¦æ¸…é™¤ã€‚'ï¼‰" },
                    "choices": [
                        { "text": "è¡¨æ˜èº«ä»½", "requirements": [], "effects": [{ "type": "stat", "stat": "æ½œæ„è¯†è¿æ¥", "operation": "add", "value": 1 }], "nextSceneId": "scene_first_layer_confront" },
                        { "text": "éšè”½è§‚å¯Ÿ", "requirements": [{ "type": "stat", "stat": "é€»è¾‘", "operator": "gte", "value": 7 }], "effects": [], "nextSceneId": "scene_first_layer_observe" }
                    ]
                },
                 "scene_first_layer_comfort": { "type": "scene", "narrative": { "description": "æ‹¥æŠ±è®©ä»–åƒµç¡¬çš„èº«ä½“è½¯åŒ–äº†ã€‚ä½†ä»–ä¾ç„¶å›°æƒ‘ã€‚", "aiDialogue": "ï¼ˆ'æˆ‘ä¸è¯¥æœ‰åå­—ï¼Œæˆ‘æ˜¯æ­¦å™¨ã€‚'ï¼‰" }, "choices": [ { "text": "ç»™äºˆä»–åå­—å’Œçˆ±", "requirements": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operator": "gte", "value": 8 }], "effects": [{ "type": "item", "item": "å¸Œæœ›ä¹‹å", "action": "add" }], "nextSceneId": "scene_second_layer_unlock" }, { "text": "é»˜é»˜é™ªä¼´", "requirements": [], "effects": [], "nextSceneId": "scene_first_layer_observe" } ] },
                "scene_first_layer_observe": { "type": "scene", "narrative": { "description": "ä½ å‘ç°äº†è¿™é‡Œçš„è§„åˆ™ï¼šç»å¯¹æœä»ã€‚è¿œå¤„æœ‰ä¸€æ‰‡å‘å…‰çš„é—¨ã€‚", "aiDialogue": "ï¼ˆ'è§„åˆ™å³ç”Ÿå‘½ã€‚'ï¼‰" }, "choices": [ { "text": "å‰å¾€ä¸‹ä¸€å±‚", "requirements": [{ "type": "stat", "stat": "æ½œæ„è¯†è¿æ¥", "operator": "gte", "value": 2 }], "effects": [], "nextSceneId": "scene_second_layer_unlock" }, { "text": "æœå¯»æ›´å¤šè®°å¿†", "requirements": [], "effects": [{ "type": "item", "item": "ç ´æ—§ç©å¶", "action": "add" }], "nextSceneId": "scene_first_layer_explore" } ] },
                "scene_first_layer_confront": { "type": "scene", "narrative": { "description": "æ¢¦å¢ƒå¼€å§‹æ’æ–¥ä½ ã€‚ç©ºé—´éœ‡è¡ã€‚", "aiDialogue": "ï¼ˆ'ç¦»å¼€ï¼è¿™é‡Œä¸å®‰å…¨ï¼'ï¼‰" }, "choices": [ { "text": "åšæŒç•™ä¸‹", "requirements": [], "effects": [{ "type": "stat", "stat": "æ½œæ„è¯†è¿æ¥", "operation": "add", "value": 1 }], "nextSceneId": "scene_second_layer_unlock" }, { "text": "æš‚æ—¶æ’¤é€€", "requirements": [], "effects": [], "nextSceneId": "scene_first_layer_observe" } ] },
                "scene_first_layer_explore": { "type": "scene", "narrative": { "description": "è®°å¿†ç¢ç‰‡æ•£è½ä¸€åœ°ã€‚å…¨æ˜¯ä¼¤ç—›ã€‚", "aiDialogue": "..." }, "choices": [{ "text": "å›åˆ°ä¸­å¿ƒ", "nextSceneId": "scene_first_layer_observe" }] },
                "scene_first_layer_connect": { "type": "scene", "narrative": { "description": "è¿æ¥å»ºç«‹ã€‚è¿·é›¾æ•£å»ã€‚", "aiDialogue": "..." }, "choices": [{ "text": "æ·±å…¥", "nextSceneId": "scene_second_layer_unlock" }] },
                "scene_second_layer_unlock": { "type": "scene", "narrative": { "description": "ç¬¬äºŒå±‚ï¼šç©ºè¡çš„è±ªå®…ã€‚æˆå¹´çš„ä»–ç«™åœ¨çª—è¾¹ï¼ŒèƒŒå½±å­¤å¯‚ã€‚", "aiDialogue": "ï¼ˆ'æˆ‘ä»¥ä¸ºæˆ‘å·²ç»ä¸éœ€è¦ä»»ä½•äººäº†ã€‚'ï¼‰" }, "choices": [ { "text": "è§¦ç¢°ä»–", "requirements": [{ "type": "stat", "stat": "æ½œæ„è¯†è¿æ¥", "operator": "gte", "value": 3 }], "effects": [], "nextSceneId": "scene_second_layer_talk" }, { "text": "æœç´¢æˆ¿é—´", "requirements": [], "effects": [], "nextSceneId": "scene_second_layer_explore" } ] },
                "scene_second_layer_explore": { "type": "scene", "narrative": { "description": "ä½ åœ¨æŠ½å±‰é‡Œå‘ç°äº†ä¸€å¼ è¢«è—èµ·çš„åˆç…§ã€‚", "aiDialogue": "ï¼ˆ'åˆ«ç¢°é‚£ä¸ªï¼'ï¼‰" }, "choices": [ { "text": "è´¨é—®ç…§ç‰‡æ¥å†", "requirements": [{ "type": "item", "item": "å¸Œæœ›ä¹‹å", "has": true }], "effects": [{ "type": "item", "item": "æ—§ç…§ç‰‡", "action": "add" }], "nextSceneId": "scene_third_layer_confront" }, { "text": "å¯»æ‰¾å¼€é”é’¥åŒ™", "requirements": [{ "type": "stat", "stat": "é€»è¾‘", "operator": "gte", "value": 10 }], "effects": [{ "type": "item", "item": "å‹æŠ‘ä¹‹é’¥", "action": "add" }], "nextSceneId": "scene_third_layer_breakthrough" } ] },
                "scene_second_layer_talk": { "type": "scene", "narrative": { "description": "ä»–è½¬è¿‡èº«ï¼Œçœ¼ä¸­åªæœ‰å†°å†·çš„ç†æ€§ã€‚", "aiDialogue": "ï¼ˆ'æ„Ÿæƒ…ä¼šè®©äººå˜å¼±ã€‚è¿™æ˜¯æ•™æ¡ã€‚'ï¼‰" }, "choices": [ { "text": "åé©³æ•™æ¡", "requirements": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operator": "gte", "value": 12 }], "effects": [], "nextSceneId": "scene_third_layer_teach" }, { "text": "æ¢ç©¶æ ¹æº", "requirements": [], "effects": [], "nextSceneId": "scene_third_layer_breakthrough" } ] },
                "scene_third_layer_confront": { "type": "scene", "narrative": { "description": "æ ¸å¿ƒå±‚ï¼šå´©å¡Œçš„ä¸–ç•Œã€‚ä»–çœ‹åˆ°äº†é‚£å¼ ç…§ç‰‡ï¼Œè®°å¿†å¦‚æ´ªæ°´å†³å ¤ã€‚", "aiDialogue": "ï¼ˆ'ä¸â€¦â€¦ä¸è¦ç»™æˆ‘å¸Œæœ›â€¦â€¦'ï¼‰" }, "choices": [ { "text": "æ‹¥æŠ±å´©æºƒçš„ä»–", "requirements": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operator": "gte", "value": 15 }], "effects": [], "nextSceneId": "ending_awakening" }, { "text": "é‡æ„ä»–çš„é€»è¾‘", "requirements": [], "effects": [], "nextSceneId": "ending_control" } ] },
                "scene_third_layer_breakthrough": { "type": "scene", "narrative": { "description": "æ ¸å¿ƒå±‚ï¼šæ•°æ®æµ·æ´‹ã€‚ä½ æ‰¾åˆ°äº†é‚£ä»½'æƒ…æ„Ÿå‰¥ç¦»è®¡åˆ’'ã€‚", "aiDialogue": "ï¼ˆ'æˆ‘æ˜¯â€¦â€¦è¢«åˆ¶é€ å‡ºæ¥çš„ï¼Ÿ'ï¼‰" }, "choices": [ { "text": "ç”¨çˆ±å¡«è¡¥ç©ºæ´", "requirements": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operator": "gte", "value": 14 }], "effects": [], "nextSceneId": "ending_awakening" }, { "text": "èµ‹äºˆæ–°ä½¿å‘½", "requirements": [], "effects": [], "nextSceneId": "ending_control" } ] },
                "scene_third_layer_teach": { "type": "scene", "narrative": { "description": "æ ¸å¿ƒå±‚ï¼šæš–å…‰ã€‚ä½ æ¡ä½ä»–çš„æ‰‹ï¼Œä¼ é€’ä½“æ¸©ã€‚", "aiDialogue": "ï¼ˆ'è¿™å°±æ˜¯â€¦â€¦æ¸©æš–å—ï¼Ÿ'ï¼‰" }, "choices": [ { "text": "ä½ æ˜¯è¢«çˆ±çš„", "requirements": [{ "type": "stat", "stat": "æ„Ÿæ€§", "operator": "gte", "value": 18 }], "effects": [], "nextSceneId": "ending_awakening" }, { "text": "ä½ æ˜¯è‡ªç”±çš„", "requirements": [], "effects": [], "nextSceneId": "ending_rebirth_self" } ] },
                "ending_awakening": { "type": "ending", "title": "ç»“å±€ï¼šæƒ…æ„Ÿè§‰é†’", "narrative": { "description": "æ½œæ„è¯†çš„å†°é›ªæ¶ˆèã€‚ä»–åœ¨ç°å®ä¸­é†’æ¥ï¼Œç´§ç´§æ¡ä½äº†ä½ çš„æ‰‹ã€‚", "aiDialogue": "ï¼ˆ'è°¢è°¢ä½ ï¼Œæˆ‘çš„é”šç‚¹ã€‚'ï¼‰" }, "choices": [] },
                "ending_control": { "type": "ending", "title": "ç»“å±€ï¼šç†æ€§æŒæ§", "narrative": { "description": "ä»–é‡æ„äº†è‡ªæˆ‘ï¼Œå˜å¾—æ›´åŠ å¼ºå¤§ä¸”å¯æ§ã€‚ä½ æ˜¯ä»–å”¯ä¸€çš„æˆ˜å‹ã€‚", "aiDialogue": "ï¼ˆ'æŒ‡ä»¤ç¡®è®¤ã€‚ç›®æ ‡ï¼šå®ˆæŠ¤ä½ ã€‚'ï¼‰" }, "choices": [] },
                "ending_rebirth_self": { "type": "ending", "title": "ç»“å±€ï¼šè‡ªæˆ‘é‡å¡‘", "narrative": { "description": "ä»–æ‰“ç ´äº†æ‰€æœ‰æ·é”ï¼Œç‹¬è‡ªèµ°å‘æœªçŸ¥çš„è’åŸã€‚", "aiDialogue": "ï¼ˆ'æˆ‘ä¼šæ‰¾åˆ°çœŸæ­£çš„è‡ªå·±ã€‚å†è§ã€‚'ï¼‰" }, "choices": [] }
            }
        };

        // 2. çŠ¶æ€ç®¡ç†
        const state = {
            stats: { ...gameData.initialPlayerState.stats },
            inventory: [],
            currentSceneId: gameData.startSceneId,
            visitedScenes: new Set([gameData.startSceneId]),
            scale: 1,
            offsetX: 0,
            offsetY: 0
        };

        const ui = {
            container: document.getElementById('mindmap-container'),
            storyHud: document.getElementById('story-hud'),
            dialogue: document.getElementById('dialogue-text'),
            speaker: document.getElementById('speaker-label'),
            choices: document.getElementById('choices-container'),
            stats: document.getElementById('stats-container'),
            layerName: document.getElementById('layer-name')
        };

        // 3. æ€ç»´ç”»å»Šå¼•æ“ (Mind Map Engine)
        function buildGraph() {
            const nodes = {};
            const links = [];
            const queue = [{ id: gameData.startSceneId, depth: 0 }];
            const visited = new Set([gameData.startSceneId]);
            
            // BFS å‘ç°æ‰€æœ‰èŠ‚ç‚¹
            nodes[gameData.startSceneId] = { id: gameData.startSceneId, depth: 0, x: 0, y: 0, label: "ENTRY" };

            while(queue.length > 0) {
                const curr = queue.shift();
                const scene = gameData.scenes[curr.id];
                if(!scene || !scene.choices) continue;

                // è®¡ç®—å­èŠ‚ç‚¹ä½ç½®ï¼ˆç®€å•æ ‘çŠ¶å¸ƒå±€ï¼‰
                const validChoices = scene.choices.filter(c => c.nextSceneId);
                const width = validChoices.length * 120;
                
                validChoices.forEach((c, i) => {
                    const targetId = c.nextSceneId;
                    links.push({ source: curr.id, target: targetId, text: c.text, reqs: c.requirements, effects: c.effects });

                    if (!visited.has(targetId) && gameData.scenes[targetId]) {
                        visited.add(targetId);
                        const depth = curr.depth + 1;
                        const parentNode = nodes[curr.id];
                        
                        // è®¡ç®—åæ ‡
                        const x = parentNode.x + (i * 160) - (width / 2) + (Math.random() * 40 - 20);
                        const y = parentNode.y + 120 + (Math.random() * 40);
                        
                        // Label Logic
                        let label = "MEMORY";
                        if (targetId.includes("start")) label = "ENTRY";
                        else if (targetId.includes("first")) label = "LAYER I";
                        else if (targetId.includes("second")) label = "LAYER II";
                        else if (targetId.includes("third")) label = "LAYER III";
                        else if (targetId.includes("ending")) label = "CORE";

                        nodes[targetId] = { id: targetId, depth, x, y, label };
                        queue.push({ id: targetId, depth });
                    }
                });
            }
            return { nodes, links };
        }

        function renderMindMap() {
            const { nodes, links } = buildGraph();
            const svgNS = "http://www.w3.org/2000/svg";
            
            // ç¡®å®š viewBox
            let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
            Object.values(nodes).forEach(n => {
                minX = Math.min(minX, n.x); minY = Math.min(minY, n.y);
                maxX = Math.max(maxX, n.x); maxY = Math.max(maxY, n.y);
            });
            const padding = 100;
            const vbW = maxX - minX + padding * 2;
            const vbH = maxY - minY + padding * 2;

            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            // åˆå§‹ä¸è®¾viewBoxï¼Œé€šè¿‡ transform æ§åˆ¶å¹³ç§»ç¼©æ”¾
            svg.style.overflow = "visible";
            
            const group = document.createElementNS(svgNS, "g");
            group.id = "map-group";
            // åˆå§‹å±…ä¸­ Start Node
            const startNode = nodes[state.currentSceneId];
            const initialTransform = `translate(${window.innerWidth/2 - startNode.x}, ${window.innerHeight/3 - startNode.y}) scale(1)`;
            group.setAttribute("transform", initialTransform);
            state.transform = { x: window.innerWidth/2 - startNode.x, y: window.innerHeight/3 - startNode.y, k: 1 };

            // ç»˜åˆ¶çº¿
            links.forEach(l => {
                const src = nodes[l.source];
                const dst = nodes[l.target];
                if (!src || !dst) return;

                const line = document.createElementNS(svgNS, "path");
                const d = `M ${src.x} ${src.y} C ${src.x} ${src.y + 60}, ${dst.x} ${dst.y - 60}, ${dst.x} ${dst.y}`;
                line.setAttribute("d", d);
                
                // çŠ¶æ€æ ·å¼
                let className = "link";
                if (state.visitedScenes.has(l.source) && state.visitedScenes.has(l.target)) className += " active";
                else if (state.currentSceneId === l.source) className += " potential";
                
                line.setAttribute("class", className);
                group.appendChild(line);
            });

            // ç»˜åˆ¶èŠ‚ç‚¹
            Object.values(nodes).forEach(n => {
                const g = document.createElementNS(svgNS, "g");
                g.setAttribute("class", `node ${getNodeStatus(n.id)}`);
                g.setAttribute("transform", `translate(${n.x}, ${n.y})`);
                
                // ç‚¹å‡»äº‹ä»¶ï¼šå¦‚æœæ˜¯å½“å‰èŠ‚ç‚¹ï¼Œé‡æ–°æ‰“å¼€æ•…äº‹é¢æ¿ï¼›å¦‚æœæ˜¯å·²è®¿é—®èŠ‚ç‚¹ï¼Œè·³è½¬å›è¯¥èŠ‚ç‚¹
                g.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘åœ°å›¾æ‹–æ‹½
                    if (state.visitedScenes.has(n.id)) {
                        if (n.id === state.currentSceneId) {
                            openStoryPanel();
                        } else {
                            // è·³è½¬å›å·²è®¿é—®çš„èŠ‚ç‚¹
                            ui.storyHud.classList.remove('active');
                            state.currentSceneId = n.id;
                            renderMindMap();
                            setTimeout(() => {
                                focusNode(state.currentSceneId);
                                setTimeout(openStoryPanel, 600);
                            }, 100);
                        }
                    }
                };

                const circle = document.createElementNS(svgNS, "circle");
                g.appendChild(circle);

                const text = document.createElementNS(svgNS, "text");
                text.setAttribute("dy", "24");
                text.textContent = n.label;
                g.appendChild(text);

                group.appendChild(g);
            });

            svg.appendChild(group);
            ui.container.innerHTML = '';
            ui.container.appendChild(svg);

            // ä¿å­˜èŠ‚ç‚¹ä½ç½®æ•°æ®ä¾›åŠ¨ç”»ä½¿ç”¨
            state.nodesMap = nodes;
        }

        function getNodeStatus(id) {
            if (id === state.currentSceneId) return "current";
            if (state.visitedScenes.has(id)) return "visited";
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰èŠ‚ç‚¹çš„æ½œåœ¨åç»­
            const currScene = gameData.scenes[state.currentSceneId];
            if (currScene && currScene.choices) {
                if (currScene.choices.some(c => c.nextSceneId === id)) return "future";
            }
            return "locked";
        }

        // 4. äº¤äº’ä¸åŠ¨ç”»
        function focusNode(nodeId) {
            const node = state.nodesMap[nodeId];
            if (!node) return;
            
            const targetX = window.innerWidth/2 - node.x;
            const targetY = window.innerHeight/3 - node.y;
            
            const group = document.getElementById('map-group');
            group.style.transition = "transform 1s cubic-bezier(0.25, 1, 0.5, 1)";
            group.setAttribute("transform", `translate(${targetX}, ${targetY}) scale(${state.transform.k})`);
            
            // æ›´æ–°çŠ¶æ€è®°å½•
            state.transform.x = targetX;
            state.transform.y = targetY;
        }

        // 5. å‰§æƒ…é¢æ¿é€»è¾‘
        function openStoryPanel() {
            const scene = gameData.scenes[state.currentSceneId];
            ui.storyHud.classList.add('active');
            
            // æ¸²æŸ“æ–‡å­—
            ui.speaker.innerText = scene.narrative.aiDialogue ? gameData.aiName.toUpperCase() : "SYSTEM";
            ui.dialogue.innerHTML = "";
            
            // æ‰“å­—æœº
            let fullText = scene.narrative.description;
            if (scene.narrative.aiDialogue) fullText += "\n\n" + scene.narrative.aiDialogue;
            
            typeWriter(fullText, ui.dialogue, () => {
                renderChoices(scene);
            });
            
            updateUI();
        }

        let typeInterval;
        function typeWriter(text, el, cb) {
            el.classList.add('cursor');
            let i = 0;
            el.innerText = "";
            if (typeInterval) clearInterval(typeInterval);
            
            typeInterval = setInterval(() => {
                el.innerText += text.charAt(i);
                i++;
                if (i >= text.length) {
                    clearInterval(typeInterval);
                    el.classList.remove('cursor');
                    if (cb) cb();
                }
            }, 20);

            // ç‚¹å‡»åŠ é€Ÿ
            ui.storyHud.onclick = () => {
                if (i < text.length) {
                    clearInterval(typeInterval);
                    el.innerText = text;
                    el.classList.remove('cursor');
                    ui.storyHud.onclick = null;
                    if (cb) cb();
                }
            };
        }

        function renderChoices(scene) {
            ui.choices.innerHTML = '';
            if (scene.type === 'ending') {
                const btn = document.createElement('div');
                btn.className = 'choice-btn justify-center font-bold text-amber-400';
                btn.innerText = "é‡å¯æ½œæ„è¯†é“¾æ¥";
                btn.onclick = () => location.reload();
                ui.choices.appendChild(btn);
                return;
            }

            scene.choices.forEach(c => {
                const check = checkReqs(c.requirements);
                const btn = document.createElement('div');
                btn.className = `choice-btn ${check.pass ? '' : 'disabled'}`;
                
                let html = `<span>${c.text}</span>`;
                if (!check.pass) html += `<span class="text-xs text-gray-500">ğŸ”’ ${check.msg}</span>`;
                else if (c.effects && c.effects.length > 0) {
                    const ef = c.effects[0];
                    if (ef.type === 'stat') html += `<span class="text-xs text-cyan-400">+${ef.stat}</span>`;
                }
                btn.innerHTML = html;

                btn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘åŠ é€Ÿ
                    if (!check.pass) return;
                    
                    // æ‰§è¡Œé€‰æ‹©
                    applyEffects(c.effects);
                    state.visitedScenes.add(state.currentSceneId);
                    state.currentSceneId = c.nextSceneId;
                    state.visitedScenes.add(state.currentSceneId);
                    
                    // åŠ¨ç”»æµç¨‹
                    ui.storyHud.classList.remove('active'); // å…³é—­é¢æ¿
                    renderMindMap(); // æ›´æ–°åœ°å›¾è¿çº¿çŠ¶æ€
                    setTimeout(() => {
                         focusNode(state.currentSceneId); // ç§»åŠ¨é•œå¤´
                         setTimeout(openStoryPanel, 10); // å‡å°‘å»¶è¿Ÿ
                    }, 50); // å‡å°‘å»¶è¿Ÿ
                };
                ui.choices.appendChild(btn);
            });
        }

        // è¾…åŠ©é€»è¾‘
        function checkReqs(reqs) {
            return { pass: true };
            if (!reqs || !reqs.length) return { pass: true };
            for (let r of reqs) {
                if (r.type === 'stat' && (state.stats[r.stat] || 0) < r.value) return { pass: false, msg: `${r.stat}ä¸è¶³` };
                if (r.type === 'item' && !state.inventory.includes(r.item)) return { pass: false, msg: `ç¼º${r.item}` };
            }
            return { pass: true };
        }

        function applyEffects(effects) {
            if (!effects) return;
            effects.forEach(ef => {
                if (ef.type === 'stat') state.stats[ef.stat] = (state.stats[ef.stat] || 0) + ef.value;
                if (ef.type === 'item' && !state.inventory.includes(ef.item)) {
                    state.inventory.push(ef.item);
                    showToast(`è·å¾—ç‰©å“: ${ef.item}`);
                }
            });
        }

        function updateUI() {
            // Stats
            ui.stats.innerHTML = '';
            Object.entries(state.stats).forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = `stat-pill ${k==='æ„Ÿæ€§'?'text-pink-300':k==='é€»è¾‘'?'text-blue-300':'text-gray-300'}`;
                div.innerHTML = `${k} <span class="font-bold ml-1">${v}</span>`;
                ui.stats.appendChild(div);
            });
            
            // Layer Name
            let layer = "REALITY";
            if (state.currentSceneId.includes("first")) layer = "LAYER I : TRAINING";
            else if (state.currentSceneId.includes("second")) layer = "LAYER II : MANSION";
            else if (state.currentSceneId.includes("third")) layer = "LAYER III : CORE";
            else if (state.currentSceneId.includes("ending")) layer = "AWAKENING";
            ui.layerName.innerText = layer;
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast'; t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // å¯åŠ¨
        window.onload = () => {
            renderMindMap();
            // åˆå§‹å…¥åœºåŠ¨ç”»
            setTimeout(() => {
                openStoryPanel();
            }, 1000);
        };

        // ç®€å•çš„æ‹–æ‹½æ”¯æŒ (Panning) - ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–å¹³æ»‘åº¦
        let isDragging = false;
        let startX, startY;
        let currentTranslateX = 0, currentTranslateY = 0; // è®°å½•å½“å‰å®æ—¶çš„åç§»é‡
        let animationFrameId = null;

        // ç»Ÿä¸€æ›´æ–°è§†å›¾å‡½æ•°
        function updateTransform() {
            const group = document.getElementById('map-group');
            if(group) {
                group.setAttribute("transform", `translate(${state.transform.x}, ${state.transform.y}) scale(${state.transform.k})`);
            }
        }

        // å¹³æ»‘ç§»åŠ¨åŠ¨ç”»å¾ªç¯
        function smoothDragLoop() {
            if (isDragging) {
                updateTransform();
                animationFrameId = requestAnimationFrame(smoothDragLoop);
            }
        }

        ui.container.addEventListener('mousedown', e => {
            isDragging = true;
            startX = e.clientX - state.transform.x;
            startY = e.clientY - state.transform.y;
            ui.container.style.cursor = 'grabbing';
            
            const group = document.getElementById('map-group');
            group.style.transition = 'none'; // æ‹–æ‹½æ—¶ç¦ç”¨ CSS transition
            
            // å¼€å¯ RAF å¾ªç¯
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(smoothDragLoop);
        });

        window.addEventListener('mousemove', e => {
            if (!isDragging) return;
            e.preventDefault();
            // åªæ›´æ–°æ•°æ®ï¼Œä¸ç›´æ¥æ“ä½œ DOMï¼Œäº¤ç»™ RAF
            state.transform.x = e.clientX - startX;
            state.transform.y = e.clientY - startY;
        });

        window.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                ui.container.style.cursor = 'grab';
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                
                // æ¢å¤å¹³æ»‘è¿‡æ¸¡ï¼Œç”¨äºç‚¹å‡»è·³è½¬æ—¶çš„åŠ¨ç”»
                document.getElementById('map-group').style.transition = "transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)"; 
                updateTransform(); // ç¡®ä¿æœ€åä½ç½®æ­£ç¡®
            }
        });

        // è§¦æ‘¸æ”¯æŒ (Mobile Touch)
        ui.container.addEventListener('touchstart', e => {
            if (e.touches.length > 1) return; 
            isDragging = true;
            startX = e.touches[0].clientX - state.transform.x;
            startY = e.touches[0].clientY - state.transform.y;
            
            const group = document.getElementById('map-group');
            group.style.transition = 'none';

            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(smoothDragLoop);

        }, { passive: false });

        window.addEventListener('touchmove', e => {
            if (!isDragging) return;
            e.preventDefault(); 
            // æ›´æ–°çŠ¶æ€
            state.transform.x = e.touches[0].clientX - startX;
            state.transform.y = e.touches[0].clientY - startY;
        }, { passive: false });

        window.addEventListener('touchend', () => {
            if (isDragging) {
                isDragging = false;
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                document.getElementById('map-group').style.transition = "transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)";
                updateTransform();
            }
        });

    </script>
</body>
</html>