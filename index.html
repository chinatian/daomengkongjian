<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>梦境连线：思维宫殿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #2a1b3d; /* Deep Purple Night */
            --node-visited: #f472b6; /* Soft Pink */
            --node-current: #fbbf24; /* Warm Gold */
            --node-future: #a78bfa; /* Lavender */
            --node-locked: #4b5563; /* Gray */
            --glass-panel: rgba(60, 30, 70, 0.85); /* Purple Glass */
            --neon-glow: 0 0 15px rgba(244, 114, 182, 0.6); /* Pink Glow */
        }

        body {
            background-color: var(--bg-dark);
            font-family: 'ZCOOL XiaoWei', serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #e2e8f0;
            user-select: none; /* 禁止选中文本以增强沉浸感 */
        }

        /* --- Layer 0: 背景网格 --- */
        .grid-bg {
            position: absolute;
            inset: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(rgba(255,200,220,0.05) 1px, transparent 1px),
                linear-gradient(rgba(255,200,220,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,200,220,0.03) 1px, transparent 1px);
            background-size: 40px 40px, 100px 100px, 100px 100px;
            transform: perspective(500px) rotateX(60deg);
            pointer-events: none;
            z-index: 0;
            animation: floatGrid 60s linear infinite;
        }
        @keyframes floatGrid { 0% { transform: perspective(500px) rotateX(60deg) translateY(0); } 100% { transform: perspective(500px) rotateX(60deg) translateY(100px); } }

        /* --- Layer 1: 思维画廊 (SVG) --- */
        #mindmap-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            cursor: grab;
            /* transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1);  移除容器级别的 transition */
        }
        #mindmap-container:active { cursor: grabbing; }

        /* SVG 元素样式 */
        .link { fill: none; stroke: #334155; stroke-width: 2px; transition: stroke 0.5s, stroke-width 0.5s; }
        .link.active { stroke: var(--node-visited); stroke-width: 3px; filter: drop-shadow(0 0 5px var(--node-visited)); }
        .link.potential { stroke: var(--node-future); stroke-dasharray: 5,5; opacity: 0.5; }

        .node circle { transition: all 0.3s; stroke-width: 0; }
        .node text { font-family: 'Nunito', sans-serif; font-size: 12px; fill: #94a3b8; text-anchor: middle; pointer-events: none; opacity: 0.7; transition: opacity 0.3s; }
        
        /* 节点状态 */
        .node.visited circle { fill: var(--node-visited); r: 6; cursor: pointer; }
        .node.visited:hover circle { filter: brightness(1.2); r: 7; }
        .node.current circle { fill: var(--node-current); stroke: #fff; stroke-width: 3px; r: 10; filter: drop-shadow(0 0 15px var(--node-current)); animation: pulse 2s infinite; }
        .node.future circle { fill: var(--bg-dark); stroke: var(--node-future); stroke-width: 2px; r: 6; cursor: pointer; }
        .node.future:hover circle { fill: var(--node-future); r: 8; }
        .node.locked circle { fill: var(--node-locked); r: 4; }

        .node:hover text { opacity: 1; fill: white; font-weight: bold; }

        @keyframes pulse { 0% { stroke-width: 0; stroke-opacity: 1; } 100% { stroke-width: 15px; stroke-opacity: 0; } }

        /* --- Layer 2: 剧情面板 (Story HUD) --- */
        #story-hud {
            position: absolute;
            bottom: 40px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            width: 90%; max-width: 600px;
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            z-index: 20;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; gap: 16px;
        }
        #story-hud.active { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

        /* 装饰性边角 */
        #story-hud::before { content: ''; position: absolute; top: -1px; left: 20px; right: 20px; height: 1px; background: linear-gradient(90deg, transparent, var(--node-current), transparent); }

        .dialogue-text {
            font-size: 1.1rem; line-height: 1.6; color: #fff; min-height: 60px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            white-space: pre-wrap; /* 保留换行符 */
        }
        .cursor::after { content: '▋'; animation: blink 1s infinite; color: var(--node-current); }
        
        .speaker-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; margin-bottom: 4px; display: block;
        }

        /* 选项按钮 */
        .choices-grid {
            display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;
        }
        .choice-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #cbd5e1;
            padding: 12px 16px;
            border-radius: 8px;
            text-align: left; cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .choice-btn:hover:not(.disabled) {
            background: rgba(251, 191, 36, 0.15); /* Amber/Gold tint */
            border-color: var(--node-current);
            transform: scale(1.02);
            color: #fff;
        }
        .choice-btn.disabled { opacity: 0.5; cursor: not-allowed; border-style: dashed; }
        .choice-btn.visited { border-color: var(--node-visited); background: rgba(244, 114, 182, 0.15); }
        .choice-btn.visited::after { content: '❤'; margin-left: 8px; color: var(--node-visited); font-weight: bold; font-size: 1.1em; }
        
        #inventory-layer {
            position: absolute; top: 20px; right: 20px; z-index: 30;
            display: flex; flex-direction: column; gap: 8px; align-items: flex-end;
        }
        .item-pill {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1);
            padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; font-family: 'Nunito', sans-serif;
            display: flex; align-items: center; gap: 8px; backdrop-filter: blur(4px);
            width: fit-content; color: #e2e8f0;
            animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .item-icon { font-size: 1.2em; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 30;
            display: flex; flex-direction: column; gap: 8px;
        }
        .stat-pill {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1);
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-family: 'Nunito', sans-serif;
            display: flex; align-items: center; gap: 6px; backdrop-filter: blur(4px);
            width: fit-content;
        }
        
        /* 提示 Toast */
        .toast {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(244, 114, 182, 0.2); border: 1px solid var(--node-visited); color: #fbcfe8;
            padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; pointer-events: none; z-index: 50;
            animation: fadeOut 3s forwards;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes fadeOut { 0% { opacity: 0; transform: translate(-50%, 10px); } 10% { opacity: 1; transform: translate(-50%, 0); } 90% { opacity: 1; } 100% { opacity: 0; } }

        /* --- Polaroid System --- */
        #polaroid-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #polaroid-overlay.active { opacity: 1; pointer-events: auto; }

        .polaroid-container {
            background: #fff;
            padding: 15px 15px 40px 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: rotate(-2deg);
            transition: transform 0.3s;
            max-width: 80vw;
            width: 320px;
        }
        .polaroid-container:hover { transform: rotate(0deg) scale(1.02); }

        .polaroid-photo {
            width: 100%; aspect-ratio: 1/1;
            background: #222;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }
        
        /* 生成图片时的视觉样式 */
        .ending-visual-gen {
            width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: contrast(1.1) sepia(0.2);
        }

        .polaroid-text {
            font-family: 'ZCOOL XiaoWei', serif;
            color: #333;
            text-align: center;
        }
        .polaroid-quote {
            font-size: 1.1rem; margin-bottom: 8px; font-weight: bold;
            line-height: 1.4;
        }
        .polaroid-meta {
            font-size: 0.7rem; color: #888; letter-spacing: 1px; text-transform: uppercase;
            display: flex; justify-content: space-between; padding: 0 5px;
        }

        #generated-image-display {
            max-width: 80vw; max-height: 70vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 4px;
        }
        
        .save-hint {
            color: #fff; margin-top: 20px; font-size: 0.9rem; opacity: 0.8;
            animation: pulseText 2s infinite;
        }
        @keyframes pulseText { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

    </style>
</head>
<body>

    <div class="grid-bg"></div>

    <!-- UI Layer -->
    <div id="ui-layer">
        <div class="stat-pill text-pink-200 border-l-4 border-l-pink-500 pl-3">
            <span class="text-xs tracking-widest uppercase">Heart Link</span>
            <span id="layer-name" class="font-bold text-white ml-2">初始化中...</span>
        </div>
        <div id="stats-container" class="flex flex-col gap-2 mt-2">
            <!-- 属性动态生成 -->
        </div>
        <div id="controls-container" class="flex gap-2 mt-4">
             <button id="btn-reset" class="text-xs border border-red-500 text-red-400 px-2 py-1 rounded hover:bg-red-900/30 transition">重置进度</button>
        </div>
    </div>

    <!-- Inventory Layer -->
    <div id="inventory-layer">
        <div class="text-xs text-gray-400 uppercase tracking-widest mb-1 mr-1">Memories</div>
        <div id="inventory-container" class="flex flex-col gap-2 items-end">
            <!-- 物品动态生成 -->
        </div>
    </div>

    <!-- Mindmap Layer (SVG) -->
    <div id="mindmap-container">
        <!-- SVG injected by JS -->
    </div>

    <!-- Story Layer (Glass Panel) -->
    <div id="story-hud">
        <div>
            <span class="speaker-label" id="speaker-label">SYSTEM</span>
            <div class="dialogue-text cursor" id="dialogue-text"></div>
        </div>
        <div class="choices-grid" id="choices-container"></div>
    </div>

    <!-- Hidden Render Target -->
    <div style="position: fixed; left: -9999px; top: 0;">
        <div id="polaroid-render-target" class="polaroid-container" style="width: 600px; padding: 30px 30px 80px 30px; transform: none;">
            <div class="polaroid-photo" style="margin-bottom: 30px;">
                <div id="render-visual" class="ending-visual-gen"></div>
                <!-- Overlay for mood -->
                <div style="position:absolute; inset:0; background: linear-gradient(135deg, rgba(0,0,0,0.1), rgba(0,0,0,0)); pointer-events: none;"></div>
                <div style="position:absolute; inset:0; box-shadow: inset 0 0 20px rgba(0,0,0,0.2); pointer-events: none;"></div>
            </div>
            <div class="polaroid-text">
                <div id="render-quote" class="polaroid-quote" style="font-size: 24px; line-height: 1.5; margin-bottom: 20px;"></div>
                <div class="polaroid-meta" style="font-size: 16px; padding: 0 10px;">
                    <span id="render-date"></span>
                    <span id="render-title" style="font-weight: bold; color: #555;"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Polaroid Overlay -->
    <div id="polaroid-overlay">
        <div class="flex flex-col items-center">
            <img id="generated-image-display" alt="Ending Card" />
            <div class="save-hint">长按上方图片保存 · 分享你的结局</div>
        </div>
        <div class="flex gap-4 mt-8">
            <button id="btn-close-polaroid" class="px-6 py-2 bg-white/10 border border-white/30 rounded-full text-white hover:bg-white/20 transition backdrop-blur-sm">查看现场</button>
            <button id="btn-restart-game" class="px-6 py-2 bg-rose-500/80 border border-rose-400 rounded-full text-white hover:bg-rose-500 transition shadow-[0_0_15px_rgba(244,63,94,0.5)] backdrop-blur-sm">重启记忆</button>
        </div>
    </div>

    <script>
        // 1. 游戏数据 (The Core)
        let gameData = {
    "gameConcept": {
        "themeName": "《楚门的世界》——真相与伪装的交织",
        "justification": "基于聊天记录中田嘉瑞的'黑芝麻馅汤圆'设定，以及他A+级杀手和邻家男孩的双重身份，这个游戏将围绕探索田嘉瑞构建的完美伪装，以及文潇如何在其中发现真相展开。玩家的状态（洞察力、情感）将影响她揭露真相的程度和方式。"
    },
    "gameTitle": "邻居是黑芝麻馅汤圆？",
    "aiName": "田嘉瑞",
    "playerNickname": "文潇",
    "initialPlayerState": {
        "stats": {
            "洞察力": 0,
            "情感": 0,
            "警惕心": 0
        },
        "inventory": []
    },
    "startSceneId": "scene_001",
    "scenes": {
        "scene_001": {
            "type": "scene",
            "narrative": {
                "description": "你刚回到家，田嘉瑞便迎了上来，关切地为你递上一杯热水。客厅的灯光柔和，驱散了冬夜的寒意。他的手指在你的肩膀上缓缓移动，为你按摩。",
                "aiDialogue": "先喝杯水吧，（把水杯递给你）在外面吹了这么久的风，别着凉了。累不累？（手指在你的肩膀上缓缓移动，力度适中）今天走了不少路。"
            },
            "choices": [
                {
                    "text": "享受他的温柔，回应说“还好。”",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "情感",
                            "operation": "add",
                            "value": 1
                        }
                    ],
                    "nextSceneId": "scene_002"
                },
                {
                    "text": "虽然温暖，但总觉得哪里不对劲，默默观察他的表情。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": 1
                        },
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 1
                        }
                    ],
                    "nextSceneId": "scene_003"
                }
            ]
        },
        "scene_002": {
            "type": "scene",
            "narrative": {
                "description": "你沉浸在他无微不至的关怀中，那一句'我的小公主'仿佛融化了所有的怀疑。然而，他身上独特的淡淡血腥气味一闪而过。",
                "aiDialogue": "那……要不要奖励一下辛苦的未婚妻？（手掌顺着你的肩膀下滑，暧昧地捏了捏你的手臂）"
            },
            "choices": [
                {
                    "text": "被他的暧昧打断思绪，羞涩地回应“嗯？”",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "情感",
                            "operation": "add",
                            "value": 1
                        }
                    ],
                    "nextSceneId": "scene_004"
                },
                {
                    "text": "血腥味？这不可能，肯定是错觉。尝试忽略它。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": -1
                        }
                    ],
                    "nextSceneId": "scene_004"
                },
                {
                    "text": "血腥味并非错觉。这跟你曾经读到的资料中的某种特殊香气很像。",
                    "requirements": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operator": "gte",
                            "value": 1
                        }
                    ],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 2
                        },
                        {
                            "type": "item",
                            "item": "可疑的香气样本",
                            "action": "add"
                        }
                    ],
                    "nextSceneId": "scene_005"
                }
            ]
        },
        "scene_003": {
            "type": "scene",
            "narrative": {
                "description": "你仔细观察，发现他眼神深处偶尔闪过一丝冰冷，和他的笑容格格不入。当他靠近你时，你闻到他身上有一股淡淡的、近乎难以察觉的铁锈味...",
                "aiDialogue": "那……要不要奖励一下辛苦的未婚妻？（手掌顺着你的肩膀下滑，暧昧地捏了捏你的手臂）"
            },
            "choices": [
                {
                    "text": "他很帅，也许是错觉。被他的魅力吸引，回应“嗯？”",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "情感",
                            "operation": "add",
                            "value": 1
                        },
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": -1
                        }
                    ],
                    "nextSceneId": "scene_004"
                },
                {
                    "text": "这不是错觉，他的气息中有一丝危险。你决定保持警惕。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 2
                        },
                        {
                            "type": "item",
                            "item": "可疑的气息记录",
                            "action": "add"
                        }
                    ],
                    "nextSceneId": "scene_005"
                }
            ]
        },
        "scene_004": {
            "type": "scene",
            "narrative": {
                "description": "他轻啄你的脸颊，坏笑着牵起你的手走向卧室。温馨的氛围让你感到安心，你顺从地跟着他。",
                "aiDialogue": "就是……（突然坏笑一声，在你脸颊上轻啄一口）这样。好啦，时间不早了，我们早点休息吧。"
            },
            "choices": [
                {
                    "text": "享受此刻的温情，告诉他“嗯好呢”。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "情感",
                            "operation": "add",
                            "value": 1
                        }
                    ],
                    "nextSceneId": "scene_006"
                },
                {
                    "text": "在他牵手的时候，感受到他手掌老茧的厚度异常，你有些在意。",
                    "requirements": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operator": "gte",
                            "value": 1
                        }
                    ],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 1
                        },
                        {
                            "type": "item",
                            "item": "异常的老茧触感",
                            "action": "add"
                        }
                    ],
                    "nextSceneId": "scene_006"
                }
            ]
        },
        "scene_005": {
            "type": "scene",
            "narrative": {
                "description": "你被他吻了一下，随即被牵着手走向卧室。虽然表面顺从，但内心的警惕让你开始思考他行为背后的涵义。他的手掌，似乎比常人要多一些老茧。",
                "aiDialogue": "就是……（突然坏笑一声，在你脸颊上轻啄一口）这样。好啦，时间不早了，我们早点休息吧。"
            },
            "choices": [
                {
                    "text": "顺从地跟着他，但脑海中盘旋着疑虑。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 1
                        }
                    ],
                    "nextSceneId": "scene_006"
                },
                {
                    "text": "故意留下一个提示，观察他的反应，例如假装掉落一个发夹。",
                    "requirements": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operator": "gte",
                            "value": 3
                        }
                    ],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": 2
                        },
                        {
                            "type": "item",
                            "item": "掉落的发夹",
                            "action": "add"
                        }
                    ],
                    "nextSceneId": "scene_007"
                }
            ]
        },
        "scene_006": {
            "type": "scene",
            "narrative": {
                "description": "他为你盖好被子，指尖轻触你的脸颊，眼中满是眷恋。你感到一种前所未有的安宁，甚至开始怀疑之前的警惕是否多余。",
                "aiDialogue": "晚安，做个好梦。（窗外的月色如水，静静地流淌在房间里）"
            },
            "choices": [
                {
                    "text": "回应他晚安，带着满足进入梦乡。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "情感",
                            "operation": "add",
                            "value": 2
                        }
                    ],
                    "nextSceneId": "scene_008"
                },
                {
                    "text": "虽然疲惫，但依然保持一丝清醒的意识，假装入睡。",
                    "requirements": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operator": "gte",
                            "value": 2
                        }
                    ],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": 1
                        }
                    ],
                    "nextSceneId": "scene_009"
                }
            ]
        },
        "scene_007": {
            "type": "scene",
            "narrative": {
                "description": "你假装不经意地掉落发夹，田嘉瑞瞬间眼神一紧，随即又恢复正常，自然地帮你拾起。他为你盖好被子，眼中看似温柔，却似乎掩藏着更深的情绪。",
                "aiDialogue": "晚安，做个好梦。（窗外的月色如水，静静地流淌在房间里）"
            },
            "choices": [
                {
                    "text": "他果然注意到了。你假装入睡，继续观察。",
                    "requirements": [],
                    "effects": [],
                    "nextSceneId": "scene_009"
                },
                {
                    "text": "他如此完美地掩饰，让你心中一寒。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 2
                        }
                    ],
                    "nextSceneId": "scene_009"
                }
            ]
        },
        "scene_008": {
            "type": "scene",
            "narrative": {
                "description": "你感觉自己被他紧紧拥入怀中，耳边传来他低沉的呢喃：'文潇，我爱你。' 你在甜蜜中沉沉睡去，对一切都浑然不觉。",
                "aiDialogue": "文潇，我爱你。（声音微不可闻，却饱含深情）"
            },
            "choices": [
                {
                    "text": "在温暖的怀抱中，你做了一个甜美的梦。",
                    "requirements": [],
                    "effects": [],
                    "nextSceneId": "ending_001"
                }
            ]
        },
        "scene_009": {
            "type": "scene",
            "narrative": {
                "description": "你假装入睡，感受着田嘉瑞起身走到窗边，背对着你。他在夜色中站立良久，周身散发出一种冰冷的气息。随后，他轻手轻脚地回到床边，将你拥入怀中。你耳边传来他低沉的呢喃：'文潇，我爱你。' 带着一丝不属于温柔的占有。",
                "aiDialogue": "文潇，我爱你。（声音微不可闻，却饱含深情）"
            },
            "choices": [
                {
                    "text": "他爱你，这是真实的。也许他只是有些秘密，但并不危险。",
                    "requirements": [
                        {
                            "type": "stat",
                            "stat": "情感",
                            "operator": "gte",
                            "value": 2
                        }
                    ],
                    "effects": [],
                    "nextSceneId": "ending_002"
                },
                {
                    "text": "他所说的“代价是一切”是什么意思？这让你感到不安。",
                    "requirements": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operator": "gte",
                            "value": 3
                        },
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operator": "gte",
                            "value": 2
                        }
                    ],
                    "effects": [],
                    "nextSceneId": "scene_010"
                }
            ]
        },
        "scene_010": {
            "type": "scene",
            "narrative": {
                "description": "半夜，你被一阵细微的响动惊醒。田嘉瑞瞬间坐起身，警惕地竖起耳朵。在确认没有异常后，他才重新躺下，将你抱得更紧，耳边私语。",
                "aiDialogue": "别怕，有我在。（窗外的风轻轻吹过，树叶沙沙作响）"
            },
            "choices": [
                {
                    "text": "他的过度警惕让你更加确信他身怀秘密。你决定主动探查。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": 2
                        },
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 2
                        }
                    ],
                    "nextSceneId": "scene_011"
                },
                {
                    "text": "即使危险近在咫尺，你仍选择相信他的保护。",
                    "requirements": [
                        {
                            "type": "stat",
                            "stat": "情感",
                            "operator": "gte",
                            "value": 3
                        }
                    ],
                    "effects": [],
                    "nextSceneId": "ending_002"
                }
            ]
        },
        "scene_011": {
            "type": "scene",
            "narrative": {
                "description": "清晨，你醒来时田嘉瑞还在熟睡。你悄悄起身，决定利用这个机会寻找线索。你的目光落在床头柜，似乎有什么东西。",
                "aiDialogue": "（清晨的阳光透过窗帘的缝隙洒进房间，睁开眼，看到你还在熟睡，宠溺地笑了笑）早安，我的小公主。（手指轻轻划过你的脸颊）"
            },
            "choices": [
                {
                    "text": "检查床头柜，看看有没有什么异常。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": 2
                        }
                    ],
                    "nextSceneId": "scene_012"
                },
                {
                    "text": "更衣时发现衣服上沾染了你从没用过的香水味。这味道似曾相识。",
                    "requirements": [
                        {
                            "type": "item",
                            "item": "可疑的香气样本",
                            "has": true
                        }
                    ],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 3
                        }
                    ],
                    "nextSceneId": "scene_013"
                }
            ]
        },
        "scene_012": {
            "type": "scene",
            "narrative": {
                "description": "你在床头柜的某个角落发现了一枚被精心隐藏的，刻着你不熟悉的符号的打火机。这并不是田嘉瑞日常使用的款式。你感到一阵心悸。",
                "aiDialogue": "（你醒了？早安。他揉了揉睡眼惺忪的眼睛，宠溺地看着你）"
            },
            "choices": [
                {
                    "text": "偷偷藏起打火机。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "item",
                            "item": "神秘打火机",
                            "action": "add"
                        },
                        {
                            "type": "stat",
                            "stat": "警惕心",
                            "operation": "add",
                            "value": 2
                        }
                    ],
                    "nextSceneId": "ending_003"
                },
                {
                    "text": "假装没发现，默默记下那个符号。",
                    "requirements": [],
                    "effects": [
                        {
                            "type": "stat",
                            "stat": "洞察力",
                            "operation": "add",
                            "value": 1
                        }
                    ],
                    "nextSceneId": "ending_003"
                }
            ]
        },
        "scene_013": {
            "type": "scene",
            "narrative": {
                "description": "你突然意识到，你身上这种不属于你的香水味，正是你在调查一起旧案时，在凶案现场提取到的蛛丝马迹！你的心跳如鼓，眼前这个深爱你的男人，到底是谁？",
                "aiDialogue": "（你醒了？早安。他揉了揉睡眼惺忪的眼睛，宠溺地看着你）"
            },
            "choices": [
                {
                    "text": "假装若无其事，却感到一股寒意从脚底直窜心头。",
                    "requirements": [],
                    "effects": [],
                    "nextSceneId": "ending_003"
                }
            ]
        },
        "ending_001": {
            "type": "ending",
            "title": "沉醉的幸福",
            "narrative": {
                "description": "你被田嘉瑞的爱意完全包围，沉浸在甜蜜的幸福中。他给了你一个完美的世界，你心甘情愿地生活在他的温柔伪装之下，从未怀疑过那份令人不安的完美。你满足地醒来，在阳光下享受他为你准备的早餐。",
                "aiDialogue": "早安，我的小公主。（他手指轻轻划过你的脸颊，宠溺地笑着）"
            },
            "choices": []
        },
        "ending_002": {
            "type": "ending",
            "title": "被保护的温室",
            "narrative": {
                "description": "你感受到他那深沉而有些占有欲的爱，尽管内心深处有一丝不安，但面对他的温柔与保护，你选择了沉溺。你相信他爱你的心是真的，也愿意接受他世界的复杂。或许有些秘密，但只要有他在，一切都安好。你成为了他精心构建的温室里，被严密保护的唯一花朵。",
                "aiDialogue": "早安，我的小公主。别怕，有我在。（他将你拥入怀中，眼中是无尽的温柔与偏执）"
            },
            "choices": []
        },
        "ending_003": {
            "type": "ending",
            "title": "揭露的迷雾",
            "narrative": {
                "description": "你发现他完美伪装下的漏洞。无论是独特的香气、异常的老茧、还是神秘的打火机，都指向了一个你未曾设想过的真相。他并非单纯的邻家男孩，而是你笔下那些充满秘密与危险的人物原型。迷雾已然开始散去，你将如何面对这个黑芝麻馅的汤圆？是选择逃离，还是深入其中，写下属于你们的结局？你看着窗外阳光下，正在为你准备早餐的田嘉瑞，他转过头，朝你露出一个完美的微笑，仿佛一切如常。但你已经知道，一切都不再寻常。",
                "aiDialogue": "早安，我的小公主。（他的笑容一如往常般温暖，但你已经能从那温暖中读出更多的含义）"
            },
            "choices": []
        }
    },
    "pre_id": ""
}

        // 2. 状态管理
        const STORAGE_KEY = 'dream_link_save_v1';
        
        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // 恢复 Set 对象
                    parsed.visitedScenes = new Set(parsed.visitedScenes);
                    parsed.selectedChoices = new Set(parsed.selectedChoices);
                    return parsed;
                } catch (e) {
                    console.error("Save file corrupted", e);
                }
            }
            return null;
        }

        const defaultState = {
            stats: { ...gameData.initialPlayerState.stats },
            inventory: [],
            currentSceneId: gameData.startSceneId,
            visitedScenes: new Set([gameData.startSceneId]),
            selectedChoices: new Set(),
            scale: 1,
            offsetX: 0,
            offsetY: 0,
            transform: { x: 0, y: 0, k: 1 } // Ensure transform is initialized
        };

        const state = loadState() || defaultState;

        function saveState() {
            const toSave = {
                ...state,
                visitedScenes: Array.from(state.visitedScenes),
                selectedChoices: Array.from(state.selectedChoices)
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
        }
        
        // 2.1 音效系统 (Sound System)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const sfx = {
            click: () => playTone(800, 'sine', 0.1),
            hover: () => playTone(400, 'sine', 0.05, 0.05),
            type: () => playNoise(0.01), // 极短的白噪音模拟打字声
            unlock: () => playMelody([500, 600, 800], 0.1)
        };

        function playTone(freq, type, duration, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playNoise(duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.value = 0.05;
            noise.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start();
        }

        function playMelody(notes, interval) {
            notes.forEach((note, i) => {
                setTimeout(() => playTone(note, 'sine', 0.2, 0.1), i * interval * 1000);
            });
        }

        document.getElementById('btn-reset').onclick = () => {
            sfx.click();
            if(confirm('确定要重置所有进度吗？')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        };

        const ui = {
            container: document.getElementById('mindmap-container'),
            storyHud: document.getElementById('story-hud'),
            dialogue: document.getElementById('dialogue-text'),
            speaker: document.getElementById('speaker-label'),
            choices: document.getElementById('choices-container'),
            stats: document.getElementById('stats-container'),
            inventory: document.getElementById('inventory-container'),
            layerName: document.getElementById('layer-name')
        };

        // 3. 思维画廊引擎 (Mind Map Engine)
        function buildGraph() {
            const nodes = {};
            const links = [];
            const queue = [{ id: gameData.startSceneId, depth: 0 }];
            const visited = new Set([gameData.startSceneId]);
            
            // BFS 发现所有节点
            nodes[gameData.startSceneId] = { id: gameData.startSceneId, depth: 0, x: 0, y: 0, label: "ENTRY" };

            while(queue.length > 0) {
                const curr = queue.shift();
                const scene = gameData.scenes[curr.id];
                // 如果是结局节点，不生成后续连线
                if(!scene || scene.type === 'ending' || !scene.choices) continue;

                // 计算子节点位置（简单树状布局）
                // 先保留原始索引，以便后续生成唯一key或保持顺序
                const validChoices = scene.choices.map((c, i) => ({...c, originalIndex: i})).filter(c => c.nextSceneId);
                const width = validChoices.length * 120;
                
                validChoices.forEach((c, i) => {
                    const targetId = c.nextSceneId;
                    // Fix: 始终添加连线，不再去重，允许同源同宿的多条边
                    links.push({ 
                        source: curr.id, 
                        target: targetId, 
                        text: c.text, 
                        reqs: c.requirements, 
                        effects: c.effects, 
                        index: i, // 在有效选项中的索引，用于绘图偏移
                        total: validChoices.length,
                        originalIndex: c.originalIndex // 原始索引，用于查找 selectedChoices
                    });

                    if (!visited.has(targetId) && gameData.scenes[targetId]) {
                        visited.add(targetId);
                        const depth = curr.depth + 1;
                        const parentNode = nodes[curr.id];
                        
                        // 计算坐标
                        const x = parentNode.x + (i * 160) - (width / 2) + (Math.random() * 40 - 20);
                        const y = parentNode.y + 120 + (Math.random() * 40);
                        
                        // Label Logic
                        let label = "Scene";
                        if (targetId.includes("start")) label = "ENTRY";
                        else if (targetId.includes("first")) label = "LAYER I";
                        else if (targetId.includes("second")) label = "LAYER II";
                        else if (targetId.includes("third")) label = "LAYER III";
                        else if (targetId.includes("ending")) label = "ENDING";

                        nodes[targetId] = { id: targetId, depth, x, y, label };
                        queue.push({ id: targetId, depth });
                    }
                });
            }
            return { nodes, links };
        }

        function renderMindMap() {
            const { nodes, links } = buildGraph();
            const svgNS = "http://www.w3.org/2000/svg";
            
            // 确定 viewBox
            let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
            Object.values(nodes).forEach(n => {
                minX = Math.min(minX, n.x); minY = Math.min(minY, n.y);
                maxX = Math.max(maxX, n.x); maxY = Math.max(maxY, n.y);
            });
            const padding = 100;
            const vbW = maxX - minX + padding * 2;
            const vbH = maxY - minY + padding * 2;

            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            // 初始不设viewBox，通过 transform 控制平移缩放
            svg.style.overflow = "visible";
            
            const group = document.createElementNS(svgNS, "g");
            group.id = "map-group";
            // 初始居中 Start Node
            const startNode = nodes[state.currentSceneId];
            const initialTransform = `translate(${window.innerWidth/2 - startNode.x}, ${window.innerHeight/3 - startNode.y}) scale(1)`;
            group.setAttribute("transform", initialTransform);
            state.transform = { x: window.innerWidth/2 - startNode.x, y: window.innerHeight/3 - startNode.y, k: 1 };

            // 绘制线
            links.forEach(l => {
                const src = nodes[l.source];
                const dst = nodes[l.target];
                if (!src || !dst) return;

                const line = document.createElementNS(svgNS, "path");
                
                // 计算偏移量，处理多条边的情况
                // 如果有多个选项指向同一个节点，或者即使指向不同节点但需要区分出口
                // 这里我们利用 link 上的 index 和 total 信息来微调控制点，使线散开
                
                const midX = (src.x + dst.x) / 2;
                const midY = (src.y + dst.y) / 2;
                
                // 根据该选项在当前节点所有选项中的位置，施加一个水平偏移
                // index 从 0 到 total-1
                // 偏移范围从 -offset 到 +offset
                const offsetRange = 60; 
                let offsetX = 0;
                if (l.total > 1) {
                    offsetX = ((l.index / (l.total - 1)) - 0.5) * offsetRange; 
                }
                
                // 简单的贝塞尔曲线，控制点加入 offsetX
                const d = `M ${src.x} ${src.y} C ${src.x + offsetX} ${src.y + 60}, ${dst.x - offsetX} ${dst.y - 60}, ${dst.x} ${dst.y}`;
                line.setAttribute("d", d);
                
                // 状态样式
                let className = "link";
                
                // 精确高亮：检查这条特定的路径（选项）是否被选择过
                const choiceKey = `${l.source}-${l.originalIndex}`;
                if (state.selectedChoices.has(choiceKey)) {
                     className += " active"; 
                } else if (state.currentSceneId === l.source) {
                    className += " potential";
                }
                
                line.setAttribute("class", className);
                group.appendChild(line);
            });

            // 绘制节点
            Object.values(nodes).forEach(n => {
                const g = document.createElementNS(svgNS, "g");
                g.setAttribute("class", `node ${getNodeStatus(n.id)}`);
                g.setAttribute("transform", `translate(${n.x}, ${n.y})`);
                
                // 点击事件：如果是当前节点，重新打开故事面板；如果是已访问节点，跳转回该节点
                g.onclick = (e) => {
                    e.stopPropagation(); // 防止触发地图拖拽
                    if (state.visitedScenes.has(n.id)) {
                        if (n.id === state.currentSceneId) {
                            openStoryPanel();
                        } else {
                            // 跳转回已访问的节点
                            ui.storyHud.classList.remove('active');
                            state.currentSceneId = n.id;
                            renderMindMap();
                            setTimeout(() => {
                                focusNode(state.currentSceneId);
                                setTimeout(openStoryPanel, 600);
                            }, 100);
                        }
                    }
                };

                const circle = document.createElementNS(svgNS, "circle");
                g.appendChild(circle);

                const text = document.createElementNS(svgNS, "text");
                text.setAttribute("dy", "24");
                text.textContent = n.label;
                g.appendChild(text);

                group.appendChild(g);
            });

            svg.appendChild(group);
            ui.container.innerHTML = '';
            ui.container.appendChild(svg);

            // 保存节点位置数据供动画使用
            state.nodesMap = nodes;
        }

        function getNodeStatus(id) {
            if (id === state.currentSceneId) return "current";
            if (state.visitedScenes.has(id)) return "visited";
            // 检查是否是当前节点的潜在后续
            const currScene = gameData.scenes[state.currentSceneId];
            if (currScene && currScene.choices) {
                if (currScene.choices.some(c => c.nextSceneId === id)) return "future";
            }
            return "locked";
        }

        // 4. 交互与动画
        function focusNode(nodeId) {
            const node = state.nodesMap[nodeId];
            if (!node) return;
            
            const targetX = window.innerWidth/2 - node.x;
            const targetY = window.innerHeight/3 - node.y;
            
            const group = document.getElementById('map-group');
            group.style.transition = "transform 1s cubic-bezier(0.25, 1, 0.5, 1)";
            group.setAttribute("transform", `translate(${targetX}, ${targetY}) scale(${state.transform.k})`);
            
            // 更新状态记录
            state.transform.x = targetX;
            state.transform.y = targetY;
        }

        // 5. 剧情面板逻辑
        function openStoryPanel() {
            const scene = gameData.scenes[state.currentSceneId];
            ui.storyHud.classList.add('active');
            
            // 隐藏旧的 speaker label，改为在文本中内嵌显示
            ui.speaker.style.display = 'none';
            ui.dialogue.innerHTML = "";
            
            // 构建带说话人的文本
            let fullText = "";
            if (scene.narrative.description) {
                fullText += `【系统】\n${scene.narrative.description}`;
            }
            if (scene.narrative.aiDialogue) {
                if (fullText) fullText += "\n\n";
                fullText += `【${gameData.aiName}】\n${scene.narrative.aiDialogue}`;
            }
            
            typeWriter(fullText, ui.dialogue, () => {
                renderChoices(scene);
            });
            
            updateUI();
        }

        let typeInterval;
        function typeWriter(text, el, cb) {
            el.classList.add('cursor');
            let i = 0;
            el.innerText = "";
            if (typeInterval) clearInterval(typeInterval);
            
            typeInterval = setInterval(() => {
                el.innerText += text.charAt(i);
                if (i % 3 === 0) sfx.type(); // 每3个字播一次音效，避免太吵
                i++;
                if (i >= text.length) {
                    clearInterval(typeInterval);
                    el.classList.remove('cursor');
                    if (cb) cb();
                }
            }, 20);

            // 点击加速
            ui.storyHud.onclick = () => {
                if (i < text.length) {
                    clearInterval(typeInterval);
                    el.innerText = text;
                    el.classList.remove('cursor');
                    ui.storyHud.onclick = null;
                    if (cb) cb();
                }
            };
        }

        // --- Polaroid System Logic ---
        function generatePolaroid(scene) {
            const overlay = document.getElementById('polaroid-overlay');
            const renderTarget = document.getElementById('polaroid-render-target');
            const visual = document.getElementById('render-visual');
            const quote = document.getElementById('render-quote');
            const date = document.getElementById('render-date');
            const title = document.getElementById('render-title');
            const imgDisplay = document.getElementById('generated-image-display');

            // 1. Setup Content
            title.innerText = scene.title;
            date.innerText = new Date().toLocaleDateString('zh-CN').replace(/\//g, '.');
            
            // Extract pure dialogue (remove brackets if needed, or keep as is)
            let dialogue = scene.narrative.aiDialogue;
            // Optional: clean up the dialogue to just the key line if it's too long or has actions
            // For now, we use the full line as it contains the mood
            quote.innerText = `“${dialogue.split('（')[0]}”`; // Simple heuristic to take the speech part

            // Visual Theme based on Ending ID
            let gradient = "linear-gradient(to bottom right, #ff9a9e, #fecfef)"; // Default Warm
            if (state.currentSceneId === 'ending_002') {
                gradient = "linear-gradient(to bottom right, #48c6ef, #6f86d6)"; // Blue/Purple
            } else if (state.currentSceneId === 'ending_003') {
                gradient = "linear-gradient(to bottom right, #bdc3c7, #2c3e50)"; // Cold/Gray
            }
            visual.style.backgroundImage = gradient;

            // 2. Render
            // We use html2canvas on the hidden element
            html2canvas(renderTarget, {
                backgroundColor: null, // Transparent background for the canvas itself
                scale: 2, // High res
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                imgDisplay.src = imgData;
                overlay.classList.add('active');
            }).catch(err => {
                console.error("Polaroid generation failed:", err);
                showToast("卡片生成失败");
            });
        }

        document.getElementById('btn-close-polaroid').onclick = () => {
             document.getElementById('polaroid-overlay').classList.remove('active');
        };
        
        document.getElementById('btn-restart-game').onclick = () => {
            if(confirm('重启记忆将清除当前进度，确定吗？')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        };

        function renderChoices(scene) {
            ui.choices.innerHTML = '';
            if (scene.type === 'ending') {
                const btn = document.createElement('div');
                btn.className = 'choice-btn justify-center font-bold text-rose-300';
                btn.innerText = "生成剧情卡片"; // Changed text
                btn.onclick = () => generatePolaroid(scene); // Call generation
                ui.choices.appendChild(btn);
                
                // Auto-generate on first arrival at ending could be nice, but a button is safer for interaction
                // Optional: Add a small "Restart" button below
                const restartBtn = document.createElement('div');
                restartBtn.className = 'choice-btn justify-center text-gray-400 text-sm mt-2 border-dashed';
                restartBtn.innerText = "重启潜意识链接";
                restartBtn.onclick = () => {
                     if(confirm('确定要重启吗？')) {
                        localStorage.removeItem(STORAGE_KEY);
                        location.reload();
                    }
                };
                ui.choices.appendChild(restartBtn);
                return;
            }

            scene.choices.forEach((c, index) => {
                const check = checkReqs(c.requirements);
                const choiceKey = `${state.currentSceneId}-${index}`;
                const isVisited = state.selectedChoices.has(choiceKey);
                
                const btn = document.createElement('div');
                btn.className = `choice-btn ${check.pass ? '' : 'disabled'} ${isVisited ? 'visited' : ''}`;
                
                let html = `<span>${c.text}</span>`;
                if (!check.pass) html += `<span class="text-xs text-gray-400">🔒 ${check.msg}</span>`;
                else if (c.effects && c.effects.length > 0) {
                    const ef = c.effects[0];
                    if (ef.type === 'stat') html += `<span class="text-xs text-pink-300">+${ef.stat}</span>`;
                }
                btn.innerHTML = html;

                btn.onmouseenter = () => sfx.hover(); // 悬停音效
                btn.onclick = (e) => {
                    e.stopPropagation(); // 防止触发加速
                    if (!check.pass) return;
                    
                    sfx.click(); // 点击音效
                    // 记录选项
                    state.selectedChoices.add(choiceKey);

                    // 执行选择
                    applyEffects(c.effects);
                    state.visitedScenes.add(state.currentSceneId);
                    state.currentSceneId = c.nextSceneId;
                    state.visitedScenes.add(state.currentSceneId);
                    
                    saveState(); // 保存进度

                    // 动画流程
                    ui.storyHud.classList.remove('active'); // 关闭面板
                    renderMindMap(); // 更新地图连线状态
                    setTimeout(() => {
                         focusNode(state.currentSceneId); // 移动镜头
                         setTimeout(openStoryPanel, 10); // 减少延迟
                    }, 50); // 减少延迟
                };
                ui.choices.appendChild(btn);
            });
        }

        // 辅助逻辑
        function checkReqs(reqs) {
            return { pass: true };
            if (!reqs || !reqs.length) return { pass: true };
            for (let r of reqs) {
                if (r.type === 'stat' && (state.stats[r.stat] || 0) < r.value) return { pass: false, msg: `${r.stat}不足` };
                if (r.type === 'item' && !state.inventory.includes(r.item)) return { pass: false, msg: `缺${r.item}` };
            }
            return { pass: true };
        }

        function applyEffects(effects) {
            if (!effects) return;
            effects.forEach(ef => {
                if (ef.type === 'stat') state.stats[ef.stat] = (state.stats[ef.stat] || 0) + ef.value;
                if (ef.type === 'item' && !state.inventory.includes(ef.item)) {
                    state.inventory.push(ef.item);
                    showToast(`获得物品: ${ef.item}`);
                    sfx.unlock(); // 获得物品音效
                }
            });
        }

        function updateUI() {
            // Stats
            ui.stats.innerHTML = '';
            Object.entries(state.stats).forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = `stat-pill ${k==='感性'?'text-pink-300':k==='逻辑'?'text-indigo-300':'text-purple-200'}`;
                div.innerHTML = `${k} <span class="font-bold ml-1">${v}</span>`;
                ui.stats.appendChild(div);
            });
            
            // Inventory
            ui.inventory.innerHTML = '';
            state.inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-pill';
                // 简单的图标映射，实际项目中可以在 gameData 里配
                let icon = '📦';
                if (item.includes('笔记')) icon = '📔';
                else if (item.includes('名')) icon = '🏷️';
                else if (item.includes('照片')) icon = '🖼️';
                else if (item.includes('玩偶')) icon = '🧸';
                else if (item.includes('钥')) icon = '🔑';
                
                div.innerHTML = `<span class="item-icon">${icon}</span> <span>${item}</span>`;
                ui.inventory.appendChild(div);
            });
            
            // Layer Name
            let layer = "REALITY";
            if (state.currentSceneId.includes("first")) layer = "LAYER I : TRAINING";
            else if (state.currentSceneId.includes("second")) layer = "LAYER II : MANSION";
            else if (state.currentSceneId.includes("third")) layer = "LAYER III : CORE";
            else if (state.currentSceneId.includes("ending")) layer = "AWAKENING";
            ui.layerName.innerText = layer;
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast'; t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // 启动
        window.onload = () => {
            renderMindMap();
            // 初始入场动画
            setTimeout(() => {
                openStoryPanel();
            }, 1000);
        };

        // 简单的拖拽支持 (Panning) - 使用 requestAnimationFrame 优化平滑度
        let isDragging = false;
        let startX, startY;
        let currentTranslateX = 0, currentTranslateY = 0; // 记录当前实时的偏移量
        let animationFrameId = null;

        // 统一更新视图函数
        function updateTransform() {
            const group = document.getElementById('map-group');
            if(group) {
                group.setAttribute("transform", `translate(${state.transform.x}, ${state.transform.y}) scale(${state.transform.k})`);
            }
        }

        // 平滑移动动画循环
        function smoothDragLoop() {
            if (isDragging) {
                updateTransform();
                animationFrameId = requestAnimationFrame(smoothDragLoop);
            }
        }

        ui.container.addEventListener('mousedown', e => {
            isDragging = true;
            startX = e.clientX - state.transform.x;
            startY = e.clientY - state.transform.y;
            ui.container.style.cursor = 'grabbing';
            
            const group = document.getElementById('map-group');
            group.style.transition = 'none'; // 拖拽时禁用 CSS transition
            
            // 开启 RAF 循环
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(smoothDragLoop);
        });

        window.addEventListener('mousemove', e => {
            if (!isDragging) return;
            e.preventDefault();
            // 只更新数据，不直接操作 DOM，交给 RAF
            state.transform.x = e.clientX - startX;
            state.transform.y = e.clientY - startY;
        });

        window.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                ui.container.style.cursor = 'grab';
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                
                // 恢复平滑过渡，用于点击跳转时的动画
                document.getElementById('map-group').style.transition = "transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)"; 
                updateTransform(); // 确保最后位置正确
            }
        });

        // 触摸支持 (Mobile Touch)
        ui.container.addEventListener('touchstart', e => {
            if (e.touches.length > 1) return; 
            isDragging = true;
            startX = e.touches[0].clientX - state.transform.x;
            startY = e.touches[0].clientY - state.transform.y;
            
            const group = document.getElementById('map-group');
            group.style.transition = 'none';

            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(smoothDragLoop);

        }, { passive: false });

        window.addEventListener('touchmove', e => {
            if (!isDragging) return;
            e.preventDefault(); 
            // 更新状态
            state.transform.x = e.touches[0].clientX - startX;
            state.transform.y = e.touches[0].clientY - startY;
        }, { passive: false });

        window.addEventListener('touchend', () => {
            if (isDragging) {
                isDragging = false;
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                document.getElementById('map-group').style.transition = "transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)";
                updateTransform();
            }
        });

    </script>
</body>
</html>